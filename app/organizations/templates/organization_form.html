{% extends "base.html" %}

{% block title %}{{ 'Редактирование' if org else 'Новое подразделение' }}{% endblock %}

{% block breadcrumbs %}
  {{ breadcrumbs([('Структура', url_for('organizations.index')), ('Форма редактирования', '#')]) }}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card-modern p-4 shadow-sm">
            <h2 class="h4 mb-4">
                <i class="fas fa-edit me-3 text-primary"></i>{{ 'Редактирование: ' ~ org.name if org else 'Создание нового объекта' }}
            </h2>

            <form method="POST" enctype="multipart/form-data">
                <div class="row g-3">
                    <!-- Блок Иерархии -->
                    <div class="col-12">
                         <label class="form-label fw-bold text-dark">Вышестоящее подразделение (подчиненность)</label>
                         <select name="parent_id" class="form-select">
                             <option value="">-- Самостоятельный объект (Корень структуры) --</option>
                             {% for item in all_orgs %}
                                <option value="{{ item.id }}" {% if org and org.parent_id == item.id %}selected{% endif %}>
                                    {{ item.name }} [{{ item.org_type or '-' }}] ({{ item.location or 'Адрес не указан' }})
                                </option>
                             {% endfor %}
                         </select>
                         <div class="form-text">Выберите организацию, в состав которой входит данный отдел или кафедра.</div>
                    </div>

                    <!-- Основная информация -->
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Наименование объекта</label>
                        <input type="text" name="name" class="form-control" value="{{ org.name if org else '' }}" required placeholder="Например: Кафедра ИТ">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Тип объекта</label>
                        <select name="org_type" class="form-select" required>
                            <option value="" disabled {% if not org or not org.org_type %}selected{% endif %}>-- Выберите тип --</option>
                            {% for t in organization_types %}
                            <option value="{{ t.name }}" {% if org and org.org_type == t.name %}selected{% endif %}>
                                {{ t.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Управляется в <a href="{{ url_for('generic_directory.index') }}" target="_blank">справочниках</a></div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Юридическое название организации</label>
                        <input type="text" name="legal_name" class="form-control" value="{{ org.legal_name if org else '' }}" placeholder="ЧОУ ВО «Московский университет им. С.Ю. Витте»">
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Фактический адрес размещения</label>
                        <input type="text" name="location" class="form-control" value="{{ org.location if org else '' }}" placeholder="г. Москва, 2-й Кожуховский проезд, д. 12, стр. 1">
                    </div>

                    <!-- Руководитель -->
                    <div class="col-md-6">
                        <label class="form-label text-muted">ФИО Руководителя</label>
                        <input type="text" name="head_of_organization" class="form-control" value="{{ org.head_of_organization if org else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted">Должность руководителя</label>
                        <input type="text" name="head_position" class="form-control" value="{{ org.head_position if org else '' }}" placeholder="Декан, Заведующий кафедрой...">
                    </div>

                    <!-- Контакты -->
                    <div class="col-md-4">
                        <label class="form-label">Общий телефон</label>
                        <input type="text" name="main_phone" class="form-control" value="{{ org.main_phone if org else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Общий Email</label>
                        <input type="email" name="main_email" class="form-control" value="{{ org.main_email if org else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Официальный сайт</label>
                        <input type="text" name="website" class="form-control" value="{{ org.website if org else '' }}" placeholder="www.muiv.ru">
                    </div>
                </div>

                <hr class="my-5">

                <!-- СЕКЦИЯ СОТРУДНИКОВ -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-users me-2 text-secondary"></i>Сотрудники и штат</h5>
                    <button type="button" id="add-contact-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus me-1"></i> Добавить сотрудника
                    </button>
                </div>
                
                <div id="contacts-container">
                    {% set contacts = org.get_contacts() if org else [] %}
                    {% for contact in contacts %}
                    <div class="contact-group border rounded p-3 mb-3 position-relative bg-light bg-opacity-50">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2 remove-contact-btn" title="Удалить"></button>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="small text-muted">ФИО</label>
                                <input type="text" name="contact_full_name" class="form-control form-control-sm" value="{{ contact.full_name }}">
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted">Должность</label>
                                <input type="text" name="contact_position" class="form-control form-control-sm" value="{{ contact.position }}">
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted">Телефон</label>
                                <input type="text" name="contact_phone" class="form-control form-control-sm" value="{{ contact.phone }}">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <hr class="my-5">

                <!-- СЕКЦИЯ ФАЙЛОВ -->
                <h5 class="mb-3"><i class="fas fa-paperclip me-2 text-secondary"></i>Медиа-материалы и документация</h5>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="p-3 border rounded">
                            <label class="form-label fw-bold">Фотографии (внешний вид, интерьер)</label>
                            <input class="form-control" type="file" name="photos" multiple accept="image/*">
                            
                            {% if photos %}
                            <div class="mt-3 d-flex flex-wrap gap-2">
                                 {% for photo_url in photos %}
                                 <div class="position-relative border rounded p-1 bg-white">
                                     <img src="{{ photo_url }}" style="height: 60px; width: 60px; object-fit: cover;" class="rounded">
                                     <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 py-0 px-1 delete-file-btn" 
                                             data-org-id="{{ org.id }}" data-subfolder="photos" data-filename="{{ photo_url.split('/')[-1] }}"
                                             style="font-size: 0.7rem; margin-top: -5px; margin-right: -5px;">&times;</button>
                                 </div>
                                 {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 border rounded h-100">
                            <label class="form-label fw-bold">Планы помещений / Чертежи (PDF, JPG)</label>
                            <input class="form-control" type="file" name="floor_plans" multiple>
                            
                            {% if floor_plans %}
                            <div class="mt-3">
                                 {% for plan_url in floor_plans %}
                                 <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                                     <a href="{{ plan_url }}" target="_blank" class="small text-truncate" style="max-width: 80%;">
                                         <i class="fas fa-file-pdf me-1 text-danger"></i> {{ plan_url.split('/')[-1] }}
                                     </a>
                                     <button type="button" class="btn btn-link text-danger btn-sm p-0 delete-file-btn" 
                                             data-org-id="{{ org.id }}" data-subfolder="floor_plans" data-filename="{{ plan_url.split('/')[-1] }}">
                                         <i class="fas fa-trash-alt"></i>
                                     </button>
                                 </div>
                                 {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="form-label fw-bold">Заметки по объекту (внутренняя информация)</label>
                    <textarea name="notes" class="form-control" rows="4" placeholder="Особенности расположения, график работы, инвентарные сведения...">{{ org.notes if org else '' }}</textarea>
                </div>

                <div class="d-flex justify-content-end gap-3 mt-5">
                    <a href="{{ url_for('organizations.index') }}" class="btn btn-outline-secondary px-4">Отмена</a>
                    <button type="submit" class="btn btn-primary px-5 shadow-sm">Сохранить данные</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Шаблон для нового сотрудника -->
<template id="contact-template">
    <div class="contact-group border rounded p-3 mb-3 position-relative bg-light">
        <button type="button" class="btn-close position-absolute top-0 end-0 m-2 remove-contact-btn"></button>
        <div class="row g-2">
            <div class="col-md-4">
                <label class="small text-muted">ФИО</label>
                <input type="text" name="contact_full_name" class="form-control form-control-sm">
            </div>
            <div class="col-md-4">
                <label class="small text-muted">Должность</label>
                <input type="text" name="contact_position" class="form-control form-control-sm">
            </div>
            <div class="col-md-4">
                <label class="small text-muted">Телефон</label>
                <input type="text" name="contact_phone" class="form-control form-control-sm">
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Добавление контактов
        const addBtn = document.getElementById('add-contact-btn');
        const container = document.getElementById('contacts-container');
        const template = document.getElementById('contact-template');

        addBtn.addEventListener('click', function() {
            container.appendChild(template.content.cloneNode(true));
        });

        // Удаление контактов
        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-contact-btn')) {
                e.target.closest('.contact-group').remove();
            }
        });

        // Удаление загруженных файлов через AJAX
        document.querySelectorAll('.delete-file-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (!confirm('Вы действительно хотите удалить этот файл?')) return;

                const orgId = this.dataset.orgId;
                const subfolder = this.dataset.subfolder;
                const filename = this.dataset.filename;
                const parentElement = this.closest('.position-relative, .d-flex');

                fetch(`/organizations/delete_file/${orgId}/${subfolder}/${filename}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        parentElement.remove();
                    } else {
                        alert('Ошибка при удалении: ' + (data.message || 'неизвестно'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Ошибка сети или сервера.');
                });
            });
        });
    });
</script>
{% endblock %}