{% extends "base.html" %}

{% block title %}Реестр организаций{% endblock %}

{% block breadcrumbs %}
  {{ breadcrumbs([('Информационно-справочный реестр', '#')]) }}
{% endblock %}

{% block extra_css %}
<style>
    /* Основные стили дерева */
    .tree-container { 
        font-family: 'Segoe UI', sans-serif; 
        overflow-x: auto; /* Добавляет скролл, если дерево уходит вправо */
        padding-bottom: 10px; /* Отступ для скроллбара */
    }
    .tree-node { 
        position: relative; 
        list-style: none; 
        min-width: 300px; /* Минимальная ширина, чтобы контент не сжимался в 0 */ 
    }
    .tree-ul { 
        padding-left: 20px; 
        margin-left: 10px; 
        border-left: 1px solid #dee2e6; 
    }
    .tree-node::before { 
        content: ""; 
        position: absolute; 
        top: 18px; 
        left: -20px; 
        width: 15px; 
        border-bottom: 1px solid #dee2e6; 
    }
    .tree-root { 
        border-left: none; 
        padding-left: 0; 
    }
    
    /* Контейнер строки дерева */
    .tree-content { 
        display: flex; 
        align-items: center; 
        padding: 8px 12px; 
        border-radius: 6px; 
        transition: 0.2s; 
        background: #fff; 
        margin-bottom: 4px; 
        border: 1px solid transparent; 
        flex-wrap: wrap; /* Разрешаем перенос элементов внутри строки */
    }
    .tree-content:hover { 
        background-color: #f1f5f9; 
        border-color: #e2e8f0; 
    }
    
    .toggle-icon { 
        cursor: pointer; 
        width: 24px; 
        margin-right: 8px; 
        color: #64748b; 
    }
    .type-icon { 
        margin-right: 10px; 
        width: 20px; 
        text-align: center; 
    }
    
    .tree-text-content {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap; /* Перенос для мобилок */
        gap: 10px;
    }

    /* Стили для иконок типов */
    .icon-uni { color: #dc3545; } 
    .icon-branch { color: #d63384; } 
    .icon-faculty { color: #0d6efd; }

    /* Адаптация под мобильные устройства */
    @media (max-width: 576px) {
        .tree-ul { 
            padding-left: 10px; /* Уменьшаем отступ вложенности на мобильном */
            margin-left: 5px; 
        }
        .tree-node::before { width: 8px; left: -13px; } /* Корректируем линии */
        
        .tree-text-content {
            flex-direction: column; /* Кнопки под текстом */
            align-items: flex-start;
            width: 100%;
        }
        
        .tree-actions {
            width: 100%;
            display: flex;
            justify-content: flex-end; /* Кнопки справа */
            border-top: 1px solid #f0f0f0;
            margin-top: 5px;
            padding-top: 5px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card-modern p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0"><i class="fas fa-sitemap me-3 text-primary"></i>Справочная система реестра</h2>
        {% if check_user_permission('manage_organizations') %}
        <a href="{{ url_for('organizations.add_org') }}" class="btn btn-primary btn-sm px-3 shadow-sm"><i class="fas fa-plus me-2"></i>Добавить</a>
        {% endif %}
    </div>

    <!-- ПАНЕЛЬ ПОИСКА -->
    <div class="bg-light p-3 border rounded mb-4 shadow-sm">
        <form method="GET" action="{{ url_for('organizations.index') }}" class="row g-3">
            <div class="col-md-6">
                <input type="text" name="q" class="form-control" placeholder="Поиск по названию, адресу, руководителю..." value="{{ request.args.get('q', '') }}">
            </div>
            <div class="col-md-3">
                <select name="type" class="form-select">
                    <option value="">Все типы</option>
                    {% for t in all_types %}
                    <option value="{{ t }}" {% if request.args.get('type') == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">Найти</button>
                <a href="{{ url_for('organizations.index') }}" class="btn btn-outline-secondary" title="Сброс"><i class="fas fa-sync-alt"></i></a>
            </div>
        </form>
    </div>

    {% if is_searching %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Результаты поиска ({{ results|length }})</h5>
            <a href="{{ url_for('organizations.export_search_results', q=request.args.get('q'), type=request.args.get('type')) }}" class="btn btn-sm btn-success">
                <i class="fas fa-file-excel me-1"></i> Скачать таблицу (.xlsx)
            </a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover border">
                <thead class="table-light">
                    <tr><th>Наименование</th><th>Тип</th><th>Адрес</th><th>Действия</th></tr>
                </thead>
                <tbody>
                    {% for org in results %}
                    <tr>
                        <td><a href="{{ url_for('organizations.view_org', org_id=org.id) }}" class="fw-bold">{{ org.name }}</a></td>
                        <td><span class="badge bg-light text-dark border">{{ org.org_type or '-' }}</span></td>
                        <td class="small text-muted">{{ org.location or '-' }}</td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('organizations.view_org', org_id=org.id) }}" class="btn btn-outline-secondary"><i class="fas fa-eye"></i></a>
                                {% if check_user_permission('manage_organizations') %}
                                <a href="{{ url_for('organizations.edit_org', org_id=org.id) }}" class="btn btn-outline-primary"><i class="fas fa-edit"></i></a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <!-- ДЕРЕВО -->
        <div class="tree-container">
            <div class="mb-3 d-flex gap-2">
                <button class="btn btn-xs btn-outline-secondary py-0" style="font-size: 0.75rem;" onclick="expandAll()">Развернуть всё</button>
                <button class="btn btn-xs btn-outline-secondary py-0" style="font-size: 0.75rem;" onclick="collapseAll()">Свернуть всё</button>
            </div>
            <ul class="tree-ul tree-root">
                {% for root in root_orgs %}
                    {{ render_tree_node(root) }}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>
{% endblock %}

{% macro render_tree_node(org) %}
<li class="tree-node">
    <div class="tree-content">
        <!-- Иконка сворачивания/разворачивания -->
        {% if org.children.count() > 0 %}
            <div class="toggle-icon" data-bs-toggle="collapse" data-bs-target="#node-{{ org.id }}"><i class="fas fa-plus-square"></i></div>
        {% else %}
            <div class="toggle-icon" style="opacity: 0.2;"><i class="fas fa-minus"></i></div>
        {% endif %}
        
        <!-- Иконка типа -->
        <div class="type-icon">
            {% if 'Университет' in (org.org_type or '') %}<i class="fas fa-university icon-uni"></i>
            {% elif 'Филиал' in (org.org_type or '') %}<i class="fas fa-building icon-branch"></i>
            {% elif 'Факультет' in (org.org_type or '') %}<i class="fas fa-graduation-cap icon-faculty"></i>
            {% else %}<i class="fas fa-folder text-warning opacity-75"></i>{% endif %}
        </div>

        <!-- Текст и Кнопки -->
        <div class="tree-text-content">
            <!-- Название и Тип -->
            <div>
                <a href="{{ url_for('organizations.view_org', org_id=org.id) }}" class="text-decoration-none fw-bold text-dark text-break">{{ org.name }}</a>
                <span class="badge bg-light text-muted border ms-2" style="font-size: 0.65rem;">{{ org.org_type }}</span>
            </div>
            
            <!-- Группа кнопок (Actions) -->
            <div class="btn-group btn-group-sm tree-actions">
                 <div class="dropdown d-inline">
                     <button class="btn btn-link text-success p-1" data-bs-toggle="dropdown" title="Скачать отчет">
                         <i class="fas fa-file-download"></i>
                     </button>
                     <ul class="dropdown-menu shadow">
                         <li><a class="dropdown-item" href="{{ url_for('organizations.export_docx', org_id=org.id) }}">
                             <i class="fas fa-file-word me-2 text-primary"></i>Ворд-карточка (.docx)
                         </a></li>
                         <li><a class="dropdown-item" href="{{ url_for('organizations.export_xlsx', org_id=org.id) }}">
                             <i class="fas fa-file-excel me-2 text-success"></i>Таблица (.xlsx)
                         </a></li>
                     </ul>
                 </div>
                 <a href="{{ url_for('organizations.view_org', org_id=org.id) }}" class="btn btn-link text-secondary p-1" title="Просмотр"><i class="fas fa-eye"></i></a>
                 {% if check_user_permission('manage_organizations') %}
                 <a href="{{ url_for('organizations.edit_org', org_id=org.id) }}" class="btn btn-link text-primary p-1" title="Редактировать"><i class="fas fa-edit"></i></a>
                 <form action="{{ url_for('organizations.delete_org', org_id=org.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Удалить объект и все подчиненные элементы?');">
                    <button type="submit" class="btn btn-link text-danger p-1" title="Удалить"><i class="fas fa-trash-alt"></i></button>
                 </form>
                 {% endif %}
            </div>
        </div>
    </div>
    
    {% if org.children.count() > 0 %}
    <ul class="tree-ul collapse" id="node-{{ org.id }}">
        {% for child in org.children %}
            {{ render_tree_node(child) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{% endmacro %}

{% block extra_js %}
<script>
    document.querySelectorAll('.tree-ul.collapse').forEach(el => {
        el.addEventListener('show.bs.collapse', e => {
            e.stopPropagation();
            const icon = e.target.parentElement.querySelector('.toggle-icon i');
            if(icon) icon.classList.replace('fa-plus-square', 'fa-minus-square');
        });
        el.addEventListener('hide.bs.collapse', e => {
            e.stopPropagation();
            const icon = e.target.parentElement.querySelector('.toggle-icon i');
            if(icon) icon.classList.replace('fa-minus-square', 'fa-plus-square');
        });
    });
    function expandAll() { document.querySelectorAll('.tree-ul.collapse').forEach(el => new bootstrap.Collapse(el, {show: true})); }
    function collapseAll() { document.querySelectorAll('.tree-ul.collapse.show').forEach(el => new bootstrap.Collapse(el, {hide: true})); }
</script>
{% endblock %}