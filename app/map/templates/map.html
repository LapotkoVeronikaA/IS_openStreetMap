<!-- map.html -->
{% extends "base.html" %}

{% block title %}Интерактивная карта{% endblock %}

{% block breadcrumbs %}
  {{ breadcrumbs([('Интерактивная карта', '#')]) }}
{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='MarkerCluster.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='MarkerCluster.Default.css') }}" />

<style>
    .map-main-container { height: 80vh; width: 100%; }
    .map-row { transition: all 0.3s ease-in-out; }
    #map-column, #map { height: 100%; }
    #map { border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.15); }
    
    /* Информационная панель */
    #info-panel {
        height: 100%;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    #info-panel-header {
        padding: 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        flex-shrink: 0;
    }
    #info-panel-title { font-weight: 600; margin-bottom: 0; }
    
    /* Контент вкладок */
    #info-panel-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
    }
    .tab-content { padding: 1rem; }
    
    .nav-tabs .nav-link {
        border-radius: 0;
        border: none;
        border-bottom: 2px solid transparent;
        color: #64748b;
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
        background: none;
    }
    
    .panel-list-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f5f9;
    }
    .panel-list-item:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block content %}
<div class="card-modern p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <h2 class="h4 mb-0">
            <i class="fas fa-map-marked-alt me-3"></i>Интерактивная карта
        </h2>
        
        <div class="d-flex align-items-center gap-2">
            <div id="search-wrapper" class="flex-grow-1" style="min-width: 300px;">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="map-search-input" class="form-control" placeholder="Поиск по названию или адресу...">
                </div>
                <div id="search-results" class="list-group" style="display: none;"></div>
            </div>
            <button class="btn btn-primary" type="button" id="toggle-filters-btn">
                <i class="fas fa-filter me-2"></i>Фильтры
            </button>
        </div>
    </div>

    <div class="map-main-container">
        <div class="row h-100 map-row g-0">
            <div class="col-md-12 h-100" id="map-column">
                <div id="map"></div>
            </div>

            <div class="col-md-3 h-100 d-none" id="filters-panel">
                <div class="p-3">
                    <h5 class="mb-3">Фильтры отображения</h5>
                    <p class="small text-muted">Выберите тип организаций для отображения на карте:</p>
                    <div class="mb-3">
                        <select id="type-filter" class="form-select form-select-sm">
                            <option value="all">Все типы</option>
                            {% for type in org_types %}
                            <option value="{{ type }}">{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button id="reset-filters-btn" class="btn btn-sm btn-outline-secondary w-100">Сбросить фильтры</button>
                </div>
            </div>

            <div class="col-md-4 h-100 d-none" id="info-panel-column">
                <div id="info-panel">
                    <div id="info-panel-header" class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 id="info-panel-title"></h5>
                            <small class="text-muted" id="info-panel-subtitle"></small>
                        </div>
                        <button type="button" class="btn-close" id="info-panel-close-btn" title="Закрыть"></button>
                    </div>
                    
                    <ul class="nav nav-tabs nav-justified" id="infoTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab"><i class="fas fa-info-circle me-1"></i>Инфо</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure" type="button" role="tab"><i class="fas fa-sitemap me-1"></i>Структура</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab"><i class="fas fa-users me-1"></i>Штат</button>
                        </li>
                    </ul>

                    <div id="info-panel-content">
                        <div class="tab-content" id="infoTabsContent">
                             <div class="tab-pane fade show active" id="general" role="tabpanel"></div>
                             <div class="tab-pane fade" id="structure" role="tabpanel"></div>
                             <div class="tab-pane fade" id="contacts" role="tabpanel"></div>
                        </div>
                    </div>
                    
                    <div class="p-2 border-top bg-light" id="info-panel-footer">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}